<!DOCTYPE html>
<html class="h-100" xmlns:th="http://www.thymeleaf.org">
    <head>
        <th:block th:replace="fragments/head :: header" />
        <title>EatAway: Chat Repartidor</title>
    </head>
    <body class="d-flex flex-column h-100">
        <header th:replace="fragments/nav.html :: nav"></header>
        <div class="col">
          <div class="container">
            <div class="row">
              <div style="border: 1px solid; border-color: black; height: 300px;"> 
                    <!-- recepción de mensajes -->
                <div class="py-5 row" id="mensajes">
                </div>
              </div>
            </div>
            <div class="row">
              <div style="display:flex; align-items:initial; margin-top: 10px;">
                 <!-- envío de mensajes -->
                 <form th:action="@{/user/2/msg}" method="POST">
                  <input type="text" id="message" placeholder="escribe a este usuario" />
                  <button id="sendmsg" class="btn btn-success" type="submit">Enviar</button>
              </form>
              &nbsp; &nbsp;
              <form th:action="@{/repartidor/} + ${idRepartidor}+ @{/listaPedidos}" method="get">
                <button type="submit" class="btn btn-success">Refrescar mensajes</button></td>
              </form>
              </div>
            </div>
          </div>
        </div>
        <th:block th:replace="fragments/footer.html :: footer" />
    </body>
</html>
<script src="/js/stomp.js"></script>
<script>
  // envio de mensajes con AJAX
  function copiarMensajeEnviado(){
    go("/user/3/msg", 'POST', {
              message: document.getElementById("message").value
          })
          .then(d => console.log("happy", d))
          .catch(e => console.log("sad", e))
  }
  let b = document.getElementById("sendmsg");
  b.onclick = (e) => {
      e.preventDefault();
      copiarMensajeEnviado();
      go(b.parentNode.action, 'POST', {
              message: document.getElementById("message").value
          })
          .then(d => console.log("happy", d))
          .catch(e => console.log("sad", e))
  }

  // cómo pintar 1 mensaje (devuelve html que se puede insertar en un div)
  function renderMsg(msg) {
      console.log("rendering: ", msg);
      return `<div>${msg.from} @${msg.sent}: ${msg.text}</div>`;
  }

  // pinta mensajes viejos al cargarse, via AJAX
  let messageDiv = document.getElementById("mensajes");
  go(config.rootUrl + "/user/received", "GET").then(ms =>
      ms.forEach(m => messageDiv.insertAdjacentHTML("beforeend", renderMsg(m)))
  );
  // y aquí pinta mensajes según van llegando
  if (ws.receive) {
      const oldFn = ws.receive; // guarda referencia a manejador anterior
      ws.receive = (m) => {
          oldFn(m); // llama al manejador anterior
          messageDiv.insertAdjacentHTML("beforeend", renderMsg(m));
      }
  }
  
</script>